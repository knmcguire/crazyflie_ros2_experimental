import os
import pathlib

import launch
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch_ros.actions import Node
from webots_ros2_driver.webots_launcher import WebotsLauncher


def generate_launch_description() -> LaunchDescription:
    package_dir = get_package_share_directory("crazyflie_ros2_simulation")
    robot_description = pathlib.Path(
        os.path.join(package_dir, "resource", "crazyflie.urdf")
    ).read_text()

    webots = WebotsLauncher(
        world=os.path.join(package_dir, "worlds", "crazyflie_apartment.wbt")
    )

    my_robot_driver = Node(
        package="webots_ros2_driver",
        executable="driver",
        output="screen",
        parameters=[
            {
                "robot_description": robot_description,
                "use_sim_time": True,
                "set_robot_state_publisher": True,
            }
        ],
    )

    robot_state_publisher = Node(
        package="robot_state_publisher",
        executable="robot_state_publisher",
        output="screen",
        parameters=[{"robot_description": '<robot name=""><link name=""/></robot>'}],
    )

    return LaunchDescription(
        [
            webots,
            my_robot_driver,
            robot_state_publisher,
            launch.actions.RegisterEventHandler(
                event_handler=launch.event_handlers.OnProcessExit(
                    target_action=webots,
                    on_exit=[launch.actions.EmitEvent(event=launch.events.Shutdown())],
                )
            ),
        ]
    )
